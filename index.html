<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Random Redirect</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 2rem; }
    .card { max-width: 560px; border: 1px solid #ddd; border-radius: 12px; padding: 24px; }
    .row { margin-top: 12px; }
    .btn { display:inline-block; padding:12px 18px; border:1px solid #333; border-radius:8px; text-decoration:none; }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", main);

    async function main() {
      const slug = extractSlug();
      if (!slug) return show("Slug が指定されていません（/go/<slug>）");

      const conf = await loadConfig(slug);
      if (!conf) return;

      if (conf.enabled === false) return show("このリンクは現在停止中です。");

      // 年齢同意（初回のみ）
      if (conf.ageGate) {
        const ok = await ensureAgeConsent();
        if (!ok) return show("アクセスがキャンセルされました。");
      }

      const urls = Array.isArray(conf.urls) ? conf.urls : [];
      if (!urls.length) return show("遷移先URLが設定されていません。");

      const dest = urls[Math.floor(Math.random() * urls.length)];
      const mode = (conf.mode || "auto").toLowerCase();

      if (mode === "click") {
        showClickGate(dest, slug);
      } else {
        location.replace(dest);
      }
    }

    function extractSlug() {
      const m = location.pathname.replace(/\/+$/, "").match(/\/go\/([^\/?#]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    async function loadConfig(slug) {
      // 顧客ごと JSON: /configs/<slug>.json
      const url = `/configs/${encodeURIComponent(slug)}.json`;
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("fetch failed");
        return await res.json();
      } catch (e) {
        show(`設定ファイルを読み込めませんでした：${url}`);
        return null;
      }
    }

    function show(html) {
      document.getElementById("app").innerHTML = html;
    }

    function showClickGate(dest, slug) {
      const safeSlug = escapeHtml(slug);
      const safeDest = dest;
      show(`
        <div class="card">
          <h2>この先に進むにはボタンをクリックしてください</h2>
          <div class="row">スラッグ：<code>${safeSlug}</code></div>
          <div class="row"><a class="btn" id="goBtn" href="#">進む</a></div>
        </div>
      `);
      document.getElementById("goBtn").addEventListener("click", (e) => {
        e.preventDefault();
        location.href = safeDest; // ASP規約に対応
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
      ));
    }

    function ensureAgeConsent() {
      const KEY = "age-ok";
      try {
        if (localStorage.getItem(KEY) === "1") return Promise.resolve(true);
      } catch (_) {}
      return new Promise((resolve) => {
        show(`
          <div class="card">
            <h2>年齢確認</h2>
            <p>この先には成人向けコンテンツが含まれる可能性があります。18歳以上ですか？</p>
            <div class="row">
              <a id="yes" class="btn" href="#">はい（18歳以上）</a>
              <a id="no"  class="btn" href="#" style="margin-left:8px;">いいえ</a>
            </div>
          </div>
        `);
        document.getElementById("yes").addEventListener("click", (e) => {
          e.preventDefault();
          try { localStorage.setItem(KEY, "1"); } catch (_) {}
          resolve(true);
        });
        document.getElementById("no").addEventListener("click", (e) => {
          e.preventDefault();
          resolve(false);
        });
      });
    }
  </script>
</head>
<body>
  <div id="app">loading…</div>
</body>
</html>
